L.AGS=L.Class.extend({});L.AGS.Layer=L.Class.extend({includes:L.Mixin.Events});L.AGS.Layer.Tiled=L.TileLayer.extend({getTileUrl:function(b,a){var c=this._url+"/tile/{z}/{y}/{x}";"offset"in this.options&&(a+=this.options.offset);c=c.replace("{s}","").replace("{z}",a).replace("{x}",b.x).replace("{y}",b.y);return"type"in this.options?c+"?type="+this.options.type:"token"in this.options?c+"?token="+this.options.token:c}});L.AGS.Layer.Tiled.Dynamic=L.AGS.Layer.Tiled.extend({defaultParams:{format:"png8",transparent:!0,nocache:!1,f:"image",bboxSR:102100},initialize:function(b,a){this._url=b;this._layerParams=L.Util.extend({},this.defaultParams);this._layerParams.width=this._layerParams.height=this.options.tileSize;for(var c in a)this.options.hasOwnProperty(c)||(this._layerParams[c]=a[c]);delete this._layerParams.token;this.parseLayers();this.parseLayerDefs();L.Util.setOptions(this,a)},onAdd:function(){L.TileLayer.prototype.onAdd.call(this,
map)},parseLayers:function(){if("undefined"===typeof this._layerParams.layers)delete this._layerParams.layerOption;else{var b=this._layerParams.layerOption||null,a=this._layerParams.layers||null,c="show",d=["show","hide","include","exclude"];delete this._layerParams.layerOption;if(b)-1!=d.indexOf(b)&&(c=b),this._layerParams.layers=c+":"+a;else if(a instanceof Array)this._layerParams.layers=c+":"+a.join(",");else if("string"===typeof a){if(b=a.match(":"))a=a.split(b[0]),Number(a[1].split(",")[0])&&
(-1!=d.indexOf(a[0])&&(c=a[0]),a=a[1]);this._layerParams.layers=c+":"+a}}},parseLayerDefs:function(){if("undefined"!==typeof this._layerParams.layerDefs){var b=this._layerParams.layerDefs,a=[];if(b instanceof Array)for(var c=b.length,d=0;d<c;d++)b[d]&&a.push(d+":"+b[d]);else if("object"===typeof b)for(c in b)a.push(c+":"+b[c]);else{delete this._layerParams.layerDefs;return}this._layerParams.layerDefs=a.join(";")}},getTileUrl:function(b){var a=this.options.tileSize,b=b.multiplyBy(a),a=b.add(new L.Point(a,
a)),b=this._map.unproject(b,this._zoom,!0),a=this._map.unproject(a,this._zoom,!0),b=this._map.options.crs.project(b),a=this._map.options.crs.project(a);this._layerParams.bbox=[b.x,a.y,a.x,b.y].join();this._layerParams.size=this.options.tileSize+","+this.options.tileSize;this._layerParams.nocache?this._layerParams.nocache=1E16*Math.random():delete this._layerParams.nocache;a=this._url+"/export"+L.Util.getParamString(this._layerParams);"undefined"!==typeof this.options.type&&(a=a+"&type="+this.options.type);
"undefined"!==typeof this.options.token&&(a=a+"&token="+this.options.token);return a}});L.AGS.Security=L.AGS.extend({token:{},options:{},initialize:function(b,a,c){L.Util.setOptions(this,a);this._url=b;this._callback=c;"undefined"!==typeof this.options.username&&"undefined"!==typeof this.options.password?this.fetchToken(this.options.username,this.options.password):this.getUserInfo()},getUserInfo:function(){var b=this,a=document.createElement("div");a.className+="esri_user_info";a.id="esri_user_info";document.body.appendChild(a);var c=document.createElement("form");a.appendChild(c);var d=
document.createElement("input");d.id="esri_login";d.type="text";"undefined"!==typeof this.options.username&&(d.value=this.options.username);c.appendChild(d);d=document.createElement("input");d.id="esri_pass";d.type="password";c.appendChild(d);d=document.createElement("input");d.id="submit";d.type="submit";c.appendChild(d);d=window.innerHeight||document.documentElement.clientHeight;a.style.left=(window.innerWidth||document.documentElement.clientWidth)/2-a.offsetWidth/2+"px";a.style.top=d/2-a.offsetHeight/
2+"px";a.style.visibility="visible";d="getComputedStyle"in window?window.getComputedStyle(a,null).backgroundColor:a.currentStyle.backgroundColor;if("transparent"==d||"rgba(0, 0, 0, 0)"==d)a.style.background="#aaaaaa";"addEventListener"in c?c.addEventListener("submit",function(c){c.preventDefault();var c=document.getElementById("esri_login").value,d=document.getElementById("esri_pass").value;a.style.display="none";document.body.removeChild(a);b.fetchToken(c,d)},!1):c.attachEvent("onSubmit",function(c){c.preventDefault();
var c=document.getElementById("esri_login").value,d=document.getElementById("esri_pass").value;a.style.display="none";document.body.removeChild(a);b.fetchToken(c,d)})},fetchToken:function(b,a){var c=this;this.options.username=b;var d=this._url+"/tokens",k="request=getToken&username="+b+"&password="+a+"&expiration=60",f=function(a,b){window.setToken=function(a){var b;"object"===typeof a&&a.token?b=a.token:"string"===typeof a&&(b=a);a=new Date;c.token={value:b,expiration:+a.setMinutes(a.getMinutes()+
59)};document.body.removeChild(document.getElementById("tokenJsonP"));delete window.setToken;"undefined"!==typeof c._callback&&c._callback()};var b="?"+b+"&f=pjson&callback=setToken",d=document.createElement("script");d.id="tokenJsonP";d.src=a+b;document.body.appendChild(d);setTimeout(function(){"undefined"===typeof c.token.value&&c.getUserInfo("failed login")},5E3)},i=function(a){var b;"object"===typeof a&&a.token?b=a.token:"string"===typeof a&&(b=a);a=new Date;c.token={value:b,expiration:+a.setMinutes(a.getMinutes()+
59)};(b=document.getElementById("tokenJsonP"))&&document.body.removeChild(b);"undefined"!==typeof c._callback&&c._callback()},h=new XMLHttpRequest;h.onreadystatechange=function(){4==h.readyState&&(400==h.status||0==h.status?(h.abort(),f(d,k)):200==h.status||304==h.status?i(h.responseText):403==h.status&&(h.abort(),c.getUserInfo("failed login")))};var n;if("FormData"in window){n=new FormData;for(var k=k.split("&"),s=0;s<k.length;s++){var t=k[s].split("=");n.append(t[0],t[1])}}else n=k;if("XDomainRequest"in
window){var g=new XDomainRequest;g.onerror=function(){g.abort();f(d,k)};g.onload=function(){i(g.responseText)};g.open("POST",d,!0);g.send(n)}else h.open("POST",d,!0),"string"===typeof n&&h.setRequestHeader("Content-type","application/x-www-form-urlencoded"),h.send(n)}});L.AGS.Tools=L.AGS.extend({});L.AGS.Tools.Identify=L.AGS.Tools.extend({options:{f:"json",sr:"4326",layers:"top",returnGeometry:!0,tolerance:1},initialize:function(b,a,c){this._layer=b;this._callback=c;L.Util.setOptions(this,a);this.parseLayerDefs();this.setMapExtent();this.setImageDisplay()},parseGeometry:function(b){if("undefined"===typeof this.options.geometryType)if("string"===typeof b){var a=b.split(",").length;2==a?this.options.geometryType="esriGeometryPoint":4==a&&(this.options.geometryType="esriGeometryEnvelope")}else b instanceof
Array?"number"===typeof b[1][0]?this.options.geometryType="esriGeometryPolyline":b[1][0]instanceof Array&&(this.options.geometryType="esriGeometryPolygon"):"object"===typeof b&&"undefined"!==typeof b.x&&(this.options.geometryType="esriGeometryPoint");this.options.geometry=b},parseLayerDefs:function(){var b=typeof this.options.layerDefs;if("undefined"!==b)if("object"===b&&!(this.options.layerDefs instanceof Array))this.options.layerDefs=JSON.stringify(this.options.layerDefs);else if(this.options.layerDefs instanceof
Array){for(var b={},a=0,c=this.options.layerDefs.length;a<c;a++)this.options.layerDefs[a]&&(b[a]=this.options.layerDefs[a]);this.options.layerDefs=JSON.stringify(b)}},setImageDisplay:function(){if("undefined"===typeof this.options.imageDisplay){var b=this._layer._map.getSize();this.options.imageDisplay=b.x+","+b.y+",96"}},setMapExtent:function(){if("undefined"===typeof this.options.mapExtent){var b=this._layer._map.getBounds();this.options.mapExtent=b._northEast.lng+","+b._southWest.lat+","+b._southWest.lng+
","+b._northEast.lat}},execute:function(b){this.parseGeometry(b);var a=this,c=this._layer._url+"/identify",d=function(c){window.parseResponse=function(c){document.body.removeChild(document.getElementById("getJsonP"));a.parseResponse(c,b);delete window.parseResponse};this.options.f="pjson";var d=document.createElement("script");d.id="getJsonP";d.src=c+L.Util.getParamString(this.options)+"&callback=parseResponse";document.body.appendChild(d)},k=function(b,c){var c=c.split(","),d=new L.LatLng(c[1],c[0]),
f=a._layer._map;if(b.results instanceof Array)if(1==b.results.length){var g=b.results[0].attributes,e=b.results[0].geometry;if(e.hasOwnProperty("x")&&e.hasOwnProperty("y")){var j=new L.LatLng(e.y,e.x),k=new L.CircleMarker(j);f.addLayer(k);setTimeout(function(){f.removeLayer(k)},5E3)}else if(e.hasOwnProperty("rings")){for(var j=[],e=e.rings,l=0,i=e[0].length;l<i;l++)d=new L.LatLng(e[0][l][1],e[0][l][0]),j.push(d);var o=new L.Polygon(j);f.addLayer(o);setTimeout(function(){f.removeLayer(o)},5E3)}for(var q in g);
}else if(1<b.results.length){q=null;for(var u=1E6,l=0,i=b.results.length;l<i;l++){console.log(b.results[l]);if("undefined"!==typeof b.results[l])if(e=b.results[l].geometry,g=b.results[l].attributes,e.hasOwnProperty("x")&&e.hasOwnProperty("y"))j=new L.LatLng(e.y,e.x),g=d.distanceTo(j),g<u&&(q=j,u=g);else if(e.hasOwnProperty("rings")){j=[];e=e.rings;g=0;for(i=e[0].length;g<i;g++)j.push(new L.LatLng(e[0][g][1],e[0][g][0]));for(var g=!1,m=j.length-1,e=0,i=j.length;e<i;e++){var v=j[e].lat,r=j[e].lng,w=
j[m].lat,m=j[m].lng,x=d.lat,p=d.lng;if(r<p&&m>=p||m<p&&r>=p)v+(p-r)/(m-r)*(w-v)<x&&(g=!g);m=e}g&&(o=new L.Polygon(j),f.addLayer(o),setTimeout(function(){f.removeLayer(o)},5E3))}else e.hasOwnProperty("paths");q&&(k=new L.CircleMarker(q),f.addLayer(k),setTimeout(function(){f.removeLayer(k)},5E3))}}},f=new XMLHttpRequest;f.onreadystatechange=function(){if(4==f.readyState)if(400==f.status||0==f.status)d(c,this.options);else if(200==f.status||302==f.status){var h=f.responseText;"undefined"!==typeof a._callback?
a._callback(h,b):(h=JSON.parse(h),k(h,b))}};formData=L.Util.getParamString(this.options).split("?")[1];if("XDomainRequest"in window){var i=new XDomainRequest;i.onerror=function(){i.abort();d(c,this.options)};i.onload=function(){setToken(i.responseText)};i.open("POST",c,!0);i.send(formData)}else f.open("POST",c,!0),"string"===typeof formData&&f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.send(formData)}});
