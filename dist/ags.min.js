L.AGS=L.Class.extend({});L.AGS.Layer=L.Class.extend({includes:L.Mixin.Events});L.AGS.Layer.Tiled=L.TileLayer.extend({getTileUrl:function(b){var a=this._url+"/tile/{z}/{y}/{x}",c=this._getZoomForUrl();"offset"in this.options&&(c+=this.options.offset);a=a.replace("{s}","").replace("{z}",c).replace("{x}",b.x).replace("{y}",b.y);return"type"in this.options?a+"?type="+this.options.type:"token"in this.options?a+"?token="+this.options.token:a}});L.AGS.Layer.Tiled.Dynamic=L.AGS.Layer.Tiled.extend({defaultParams:{format:"png8",transparent:!0,nocache:!1,f:"image",bboxSR:102100},initialize:function(b,a){this._url=b;this._layerParams=L.Util.extend({},this.defaultParams);this._layerParams.width=this._layerParams.height=this.options.tileSize;for(var c in a)this.options.hasOwnProperty(c)||(this._layerParams[c]=a[c]);delete this._layerParams.token;this.parseLayers();this.parseLayerDefs();L.Util.setOptions(this,a)},onAdd:function(){L.TileLayer.prototype.onAdd.call(this,
map)},parseLayers:function(){if("undefined"===typeof this._layerParams.layers)delete this._layerParams.layerOption;else{var b=this._layerParams.layerOption||null,a=this._layerParams.layers||null,c="show",e=["show","hide","include","exclude"];delete this._layerParams.layerOption;if(b)-1!=e.indexOf(b)&&(c=b),this._layerParams.layers=c+":"+a;else if(a instanceof Array)this._layerParams.layers=c+":"+a.join(",");else if("string"===typeof a){if(b=a.match(":"))a=a.split(b[0]),Number(a[1].split(",")[0])&&
(-1!=e.indexOf(a[0])&&(c=a[0]),a=a[1]);this._layerParams.layers=c+":"+a}}},parseLayerDefs:function(){if("undefined"!==typeof this._layerParams.layerDefs){var b=this._layerParams.layerDefs,a=[];if(b instanceof Array)for(var c=b.length,e=0;e<c;e++)b[e]&&a.push(e+":"+b[e]);else if("object"===typeof b)for(c in b)a.push(c+":"+b[c]);else{delete this._layerParams.layerDefs;return}this._layerParams.layerDefs=a.join(";")}},getTileUrl:function(b){var a=this.options.tileSize,b=b.multiplyBy(a),a=b.add(new L.Point(a,
a)),b=this._map.unproject(b,this._zoom,!0),a=this._map.unproject(a,this._zoom,!0),b=this._map.options.crs.project(b),a=this._map.options.crs.project(a),a=[b.x,a.y,a.x,b.y].join();this._layerParams.bbox=a;this._layerParams.size=this.options.tileSize+","+this.options.tileSize;this._layerParams.nocache?this._layerParams.nocache=1E16*Math.random():delete this._layerParams.nocache;a=this._url+"/export"+L.Util.getParamString(this._layerParams);"undefined"!==typeof this.options.type&&(a=a+"&type="+this.options.type);
"undefined"!==typeof this.options.token&&(a=a+"&token="+this.options.token);return a}});L.AGS.Security=L.AGS.extend({token:{},options:{},initialize:function(b,a,c){L.Util.setOptions(this,a);this._url=b;this._callback=c;"undefined"!==typeof this.options.username&&"undefined"!==typeof this.options.password?this.fetchToken(this.options.username,this.options.password):this.getUserInfo()},getUserInfo:function(){var b=this,a=document.createElement("div");a.className+="esri_user_info";a.id="esri_user_info";document.body.appendChild(a);var c=document.createElement("form");a.appendChild(c);var e=
document.createElement("input");e.id="esri_login";e.type="text";"undefined"!==typeof this.options.username&&(e.value=this.options.username);c.appendChild(e);e=document.createElement("input");e.id="esri_pass";e.type="password";c.appendChild(e);e=document.createElement("input");e.id="submit";e.type="submit";c.appendChild(e);e=window.innerHeight||document.documentElement.clientHeight;a.style.left=(window.innerWidth||document.documentElement.clientWidth)/2-a.offsetWidth/2+"px";a.style.top=e/2-a.offsetHeight/
2+"px";a.style.visibility="visible";e="getComputedStyle"in window?window.getComputedStyle(a,null).backgroundColor:a.currentStyle.backgroundColor;if("transparent"==e||"rgba(0, 0, 0, 0)"==e)a.style.background="#aaaaaa";"addEventListener"in c?c.addEventListener("submit",function(c){c.preventDefault();var c=document.getElementById("esri_login").value,e=document.getElementById("esri_pass").value;a.style.display="none";document.body.removeChild(a);b.fetchToken(c,e)},!1):c.attachEvent("onSubmit",function(c){c.preventDefault();
var c=document.getElementById("esri_login").value,e=document.getElementById("esri_pass").value;a.style.display="none";document.body.removeChild(a);b.fetchToken(c,e)})},fetchToken:function(b,a){var c=this;this.options.username=b;var e=this._url+"/tokens",i="request=getToken&username="+b+"&password="+a+"&expiration=60",j=function(a,b){window.setToken=function(a){var b;"object"===typeof a&&a.token?b=a.token:"string"===typeof a&&(b=a);a=new Date;c.token={value:b,expiration:+a.setMinutes(a.getMinutes()+
59)};document.body.removeChild(document.getElementById("tokenJsonP"));delete window.setToken;"undefined"!==typeof c._callback&&c._callback()};var b="?"+b+"&f=pjson&callback=setToken",d=document.createElement("script");d.id="tokenJsonP";d.src=a+b;document.body.appendChild(d);setTimeout(function(){"undefined"===typeof c.token.value&&c.getUserInfo("failed login")},5E3)},h=function(a){var b;"object"===typeof a&&a.token?b=a.token:"string"===typeof a&&(b=a);a=new Date;c.token={value:b,expiration:+a.setMinutes(a.getMinutes()+
59)};(b=document.getElementById("tokenJsonP"))&&document.body.removeChild(b);"undefined"!==typeof c._callback&&c._callback()},d=new XMLHttpRequest;d.onreadystatechange=function(){4==d.readyState&&(400==d.status||0==d.status?(d.abort(),j(e,i)):200==d.status||304==d.status?h(d.responseText):403==d.status&&(d.abort(),c.getUserInfo("failed login")))};var l;if("FormData"in window){l=new FormData;for(var i=i.split("&"),k=0;k<i.length;k++){var f=i[k].split("=");l.append(f[0],f[1])}}else l=i;if("XDomainRequest"in
window){var g=new XDomainRequest;g.onerror=function(){g.abort();j(e,i)};g.onload=function(){h(g.responseText)};g.open("POST",e,!0);g.send(l)}else d.open("POST",e,!0),"string"===typeof l&&d.setRequestHeader("Content-type","application/x-www-form-urlencoded"),d.send(l)}});L.AGS.Tools=L.AGS.extend({});L.AGS.Tools.Identify=L.AGS.Tools.extend({options:{f:"json",sr:"4326",layers:"top",returnGeometry:!0,tolerance:1},initialize:function(b,a,c){this._layer=b;this._callback=c;L.Util.setOptions(this,a);this.parseLayerDefs();this.setMapExtent();this.setImageDisplay()},parseGeometry:function(b){if("undefined"===typeof this.options.geometryType)if("string"===typeof b){var a=b.split(",").length;2==a?this.options.geometryType="esriGeometryPoint":4==a&&(this.options.geometryType="esriGeometryEnvelope")}else b instanceof
Array?"number"===typeof b[1][0]?this.options.geometryType="esriGeometryPolyline":b[1][0]instanceof Array&&(this.options.geometryType="esriGeometryPolygon"):"object"===typeof b&&"undefined"!==typeof b.x&&(this.options.geometryType="esriGeometryPoint");this.options.geometry=b},parseLayerDefs:function(){var b=typeof this.options.layerDefs;if("undefined"!==b)if("object"===b&&!(this.options.layerDefs instanceof Array))this.options.layerDefs=JSON.stringify(this.options.layerDefs);else if(this.options.layerDefs instanceof
Array){for(var b={},a=0,c=this.options.layerDefs.length;a<c;a++)this.options.layerDefs[a]&&(b[a]=this.options.layerDefs[a]);this.options.layerDefs=JSON.stringify(b)}},setImageDisplay:function(){if("undefined"===typeof this.options.imageDisplay){var b=this._layer._map.getSize();this.options.imageDisplay=b.x+","+b.y+",96"}},setMapExtent:function(){if("undefined"===typeof this.options.mapExtent){var b=this._layer._map.getBounds();this.options.mapExtent=b._northEast.lng+","+b._southWest.lat+","+b._southWest.lng+
","+b._northEast.lat}},execute:function(b){this.parseGeometry(b);var a=this,c=this._layer._url+"/identify",e=function(c){window.parseResponse=function(c){document.body.removeChild(document.getElementById("getJsonP"));a.findBestFeature(c,b);delete window.parseResponse};this.options.f="pjson";var d=document.createElement("script");d.id="getJsonP";d.src=c+L.Util.getParamString(this.options)+"&callback=parseResponse";document.body.appendChild(d)},i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==
i.readyState)if(400==i.status||0==i.status)e(c,this.options);else if(200==i.status||302==i.status){var h=i.responseText,d=b,d=d.split(","),l=new L.LatLng(d[1],d[0]),k=a._layer._map,h=JSON.parse(h);if(h.results instanceof Array)if(1==h.results.length)if("undefined"!==typeof a._callback)a._callback(h.results[0]);else{var f=h.results[0].geometry;if(f.hasOwnProperty("x")&&f.hasOwnProperty("y")){var g=new L.LatLng(f.y,f.x),j=new L.CircleMarker(g);k.addLayer(j);setTimeout(function(){k.removeLayer(j)},5E3)}else if(f.hasOwnProperty("rings")){for(var g=
[],f=f.rings,d=0,n=f[0].length;d<n;d++)h=new L.LatLng(f[0][d][1],f[0][d][0]),g.push(h);var p=new L.Polygon(g);k.addLayer(p);setTimeout(function(){k.removeLayer(p)},5E3)}}else if(1<h.results.length){console.log("more than 1");for(var r=null,u=1E6,t=null,d=0,n=h.results.length;d<n;d++)if("undefined"!==typeof h.results[d])if(f=h.results[d].geometry,f.hasOwnProperty("x")&&f.hasOwnProperty("y"))g=new L.LatLng(f.y,f.x),g=g.distanceTo(l),g<u&&(r="point",u=g,t=d);else if(f.hasOwnPropety("rings")){for(var g=
[],f=f.rings,m=0,n=f.length;m<n;m++)g.push(new L.LatLng(f[0][m][1],f[0][m][0]));for(var f=!1,o=g.length-1,m=0,n=g.length;m<n;m++){var v=g[m].lat,s=g[m].lng,w=g[o].lat,o=g[o].lng,x=l.lat,q=l.lng;if(s<q&&o>=q||o<q&&s>=q)v+(q-s)/(o-s)*(w-v)<x&&(f=!f);o=m}if(f){r="polygon";t=d;break}}h=h.results[t];if("undefined"!==typeof a._callback)a._callback(h);else if(f=h.geometry,"point"==r)g=new L.LatLng(f.y,f.x),j=new L.CircleMarker(g),k.addLayer(j),setTimeout(function(){k.removeLayer(j)},5E3);else if("polygon"==
r){g=[];f=f.rings;d=0;for(n=f.length;d<n;d++)g.push(new L.LatLng(f[0][d][1],f[0][d][0]));p=new L.Polygon(g);k.addLayer(p);setTimeout(function(){k.removeLayer(p)},5E3)}}}};formData=L.Util.getParamString(this.options).split("?")[1];if("XDomainRequest"in window){var j=new XDomainRequest;j.onerror=function(){j.abort();e(c,this.options)};j.onload=function(){setToken(j.responseText)};j.open("POST",c,!0);j.send(formData)}else i.open("POST",c,!0),"string"===typeof formData&&i.setRequestHeader("Content-type",
"application/x-www-form-urlencoded"),i.send(formData)}});
